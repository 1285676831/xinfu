<!DOCTYPE html>
<html>

<head>
	${inc:/action/project/fitness/home/pub}
	<title>活动列表</title>
</head>
<style>
	.b-i-main nav li>label {
    color: #848588;
	width: 73px;}
	.b-i-main nav li input{
		
   width: 130px;}
  .hdlb {padding-top: 32px;	   
   }
   .iradio_square-blue{
	   margin: 0 10px 5px 0;
	   transform: scale(0.7,0.7);
   }
   .suoyou{
	   color: red;
   }
   .b-i-main .nav_li{
	   margin-top:-20px;
   }
</style>
<body>
	<div class="modal fade" id="modalAddnew" tabindex="-1" style='display:none;'>
		<div class="basic-information modal-dialog dialogbg">
			<header class="header-default">
				<span id="formTitle"></span>
				<span class="header-close"></span>
			</header>
			<form id="messageForm" name="messageForm" method="post">
				<div class="b-i-main">
					<input type="hidden" id="c_code" name="c_code" value="" />
					<nav>
						<li>
							<label for="">活动名称</label>
							<input type="text" id="c_campaign_name" name="c_campaign_name" maxlength="80" />
						</li>

						<li>
							<label for="">绑定体验卡</label>
							<input type="text" id="c_expercardcode" name="c_expercardcode" maxlength="80" readonly="readonly" preserve="true" />
						</li>

						<li class="nav_li">
							<label for="">
								<span class="suoyou">*</span>发卡数量</label>

								<div class="hdlb">
							<div>
									
								<input type="radio" class="form-control" name="totalnum" />
								<label for="">无限制</label>
							</div>
							<div>
								<input type="radio" class="form-control" name="totalnum" />
								<label for="">发放</label>

								<input type="text" id="c_totalnum" name="c_totalnum" maxlength="80" /> 张
							</div></div>
						</li>


						<li class="nav_li">
								<label for="">
										<span class="suoyou">*</span>领取限制</label>
								<div class="hdlb">
							<div>
								
								<input type="radio" class="form-control" name="personnum" />
								<label for="">无限制</label>
							</div>
							<div>
								<input type="radio" class="form-control" name="personnum" />
								<label for="">一人限领</label>

								<input type="text" id="c_personnum" name="c_personnum" maxlength="80" /> 张
							</div>
						</div>
						</li>



						<li class="nav_li">
							<label for="">
								<span class="suoyou">*</span>活动有效期</label>
								<div class="hdlb" style="width:600px;">
							<div>
								<input id="cqieffect" type="radio" class="form-control" name="c_validatetype" value="0" />
								<label for="">长期有效</label>
							</div>
							<div>
								<input id="riqi" type="radio" class="form-control" name="c_validatetype" value="1" />
								<label for="">日期</label>

							</div>
							
						</div>
						</li>


<li><div style="margin-left: 88px;
    width: 500px;">
							
		<label for="">开始日期</label>	<input class='and_date' type="text" id="c_startdate" name="c_startdate" maxlength="80" />

	
	
		<label for="">结束日期</label>	<input class='and_date'  type="text" id="c_enddate" name="c_enddate" maxlength="80" />
	</div></li>

						<li class="nav_li">
							<label for="">排名规则</label>

							<div class="hdlb">
								<div>
									<input type="radio" class="form-control" name="c_rankrules" value="0" />
									<label for="">以到店人数排名</label>
								</div>
								<div>
									<input type="radio" class="form-control" name="c_rankrules" value="1" />
									<label for="">以领卡数量排名</label>
								</div>
							</div>
						</li>

<li></li>

						<li>
							<label for="">页面链接</label>
							<input style="width:600px;" type="text" name="c_link" id="c_link" />
						</li>


						<li>
							<label for=""><span class="suoyou">*</span>启用状态</label>
							<div class="my-selected">
								<select id="c_status" name="c_status" disabled="disabled">
									<option value="2">未启用</option>
									<option value="1">启用</option>
									<option value="0">无效</option>
								</select>
							</div>
						</li>


						<li class="to100w">
							<label for="">活动规则</label>
							<textarea id="c_campaignrules" name="c_campaignrules" placeholder="暂无数据" class="my-textarea" rows="" cols="4"></textarea>
						</li>
					</nav>
				</div>
				<footer class="footer-default">
					<button id="save_btn" type="button">保存</button>
				</footer>
			</form>
		</div>
	</div>

	<form role="form" method="post" id="searchForm">
		<input name="sort" type="hidden" value="code" preserve="true" />
		<input name="order" type="hidden" value="desc" preserve="true" />
		<input name="pageNo" type="hidden" value="" preserve="true" />
		<input name="totalPages" type="hidden" value="" preserve="true" />

		<input name="status" id="status" type="hidden" value="" preserve="true" />
		<div class="am-tabs-bd r-tab-cont">
			<div class="c-n-nav-2 am-tab-panel am-in am-active am-fade three-none">
				<div class="tab-cout-nav">
					<div class="tab-cout-nav-t">
						<nav class="tab-nav-my">
							<li>
								<input type="text" id="s_name" name="s_name" placeholder="请输入活动名称" class="input-default" />
							</li>

							<li>
								<div class="my-selected">
									<select id="s_status" name="s_status" style="display: none;">
										<option value="">全部状态</option>
										<option value="0">无效</option>
										<option value="1">已启用</option>
										<option value="2">未启用</option>
									</select>
								</div>
							</li>
							<div class="r-c-btnList">
								<button type="button" class="r-c-3-btn-1" id="search_btn"></button>
								<img src="${def:context}/js/project/fitness/image/SVG/nav/xinzengkecheng.svg" alt="" data-toggle="modal" id="addnew_btn">
							</div>
						</nav>
					</div>
					<div class="tab-cout-nav-b">
						<nav class="r-c-3-t-b-l">

						</nav>
						<nav class="r-c-3-t-b-r">
							<li>
								<img src="${def:context}/js/project/fitness/image/SVG/nav/yulan.svg" title='查看' alt="" id="see_btn">
							</li>
							<li>
								<img src="${def:context}/js/project/fitness/image/SVG/btn/kaiqi.svg" title='启用' alt="" id="start_btn">
							</li>
							<li>
								<img src="${def:context}/js/project/fitness/image/SVG/btn/jinyong.svg" title='禁用' alt="" id="disable_btn">
							</li>
							<li>
								<img src="${def:context}/js/project/fitness/image/SVG/nav/xiugai.svg" alt="" id="edit_btn">
							</li>
							<li>
								<img src="${def:context}/js/project/fitness/image/SVG/nav/shanchu.svg" alt="" id="delete_btn">
							</li>
						</nav>
					</div>
				</div>
				<div class="r-tab-cout-3-b">
					<div class="to-change-background"></div>
					<table>
						<thead>
							<tr>
								<th class="table-checkbox">
									<label class="am-checkbox">
										<input id="selectAll" name="datalist" type="checkbox" value="" style="display: none;">
									</label>
								</th>
								<th>活动名称</th>
								<th>体验卡名称</th>
								<th>体验卡类型</th>
								<th>活动有效期</th>
								<th>领取人次</th>
								<th>已使用</th>
								<th>活动状态</th>
								<th>活动转换率</th>
								<th colspan="2">操作</th>
							</tr>
						</thead>

						<tbody id="datagridTemplate" style="display: none">
							<tr>
								<td class="table-checkbox">#application_id#</td>
								<td>#campaign_name#</td>
								<td>#name#</td>
								<td>#expertype#</td>
								<td>#validatetype#</td>
								<td>#lingnum#</td>
								<td>#usenum#</td>
								<td>#status#</td>
								<td></td>
								<td>
									<button class="btn btn-info btn-sm" type="button" id="see" onclick="gotoTiyanka(#code#)">体验卡</button>
									<button class="btn btn-info btn-sm" type="button" id="see" onclick="gotoReport(#code#,#expercardcode#)">数据查看</button>
								</td>
							</tr>
						</tbody>
						<tbody id="datagrid">
						</tbody>
					</table>
					<div class="pageDiv">
						<ul class="pagination">
						</ul>
					</div>
				</div>
			</div>
		</div>
	</form>

	<input type="hidden" name="actionroot" id="actionroot" value="${def:actionroot}" />
	<script language="JavaScript">
		var search = null;
		$(document).ready(function () {
			searchSelectInit($("#c_status,#s_status"));


			$Dialog().date($('#c_startdate'));
			$Dialog().date($('#c_enddate'));
			$(".header-close").unbind().on("click", function () {
				$("#modalAddnew").modal('hide');
				ccms.util.clearForm('messageForm');
			});
			//批量启用
			$("#start_btn").unbind().on("click", function () {
				updateStatus(1);
			});
			//批量禁用
			$("#disable_btn").unbind().on("click", function () {
				updateStatus(2);
			});

			$("input[name=totalnum]:eq(0)").on("ifClicked", function () {
				$('#c_totalnum').val('');
			});

			$("input[name=totalnum]:eq(1)").on("ifClicked", function () {
				$('#c_totalnum').val(1);
			});

			$("input[name=personnum]:eq(0)").on("ifClicked", function () {
				$('#c_personnum').val('');
			});

			$("input[name=personnum]:eq(1)").on("ifClicked", function () {
				$('#c_personnum').val(1);
			});

			$("input[name=c_validatetype]:eq(0)").on("ifClicked", function () {
				$('#c_startdate').val('');
				$('#c_enddate').val('');
			});
			$("#cqieffect").on("ifClicked", function () {
				$(".and_date").attr("disabled","disabled");
				
			});
			$("#riqi").on("ifClicked", function () {
				$(".and_date").removeAttr("disabled");
				
			});
			

			var obj = $Crud({
				formId: "messageForm",
				button: "save_btn",
				bpkField: "c_code",
				insertBack: function () {
					search.searchData();
				},
				updateBack: function () {
					search.searchData();
				},
				deleteBack: function () {
					search.searchData();
				},
				addNewBack: function () {
					setSelectValue($('#c_status'), "2");
					$('#c_expercardcode').val('');
					$('#save_btn').show();
					$("#formTitle").html("新增");
				},
				editBack: function () {},
				validate: function () {
					if ($("input[name=c_validatetype]:eq(1)").is(':checked')) {
						if ($('#c_startdate').val() == '' || $('#c_enddate') == '') {
							ccms.dialog.notice('日期不能为空');
							return false;
						}
					}
					var flag = $("#messageForm").validate({});
					return flag;
				}
			}).init();

			this.search = search;
			search = $Search({
				datagrid: "datagrid",
				formId: "searchForm",
				validate: function () {
					$('#status').val(0);
					return true;
				},
				rowpackage: function (obj) {
					if (obj.status == "已启用") {
						$('#status').val(1);
					}
				},
				success: function () {
					ccms.util.renderCheckbox("datalist");
					//全选   取消全选
					$("#selectAll").unbind().on("ifChecked", function () { //点击事件未选中
						$('input[name=datalist]').iCheck('check'); //
					}).on("ifUnchecked", function () { //点击事件未选中
						$('input[name=datalist]').iCheck('uncheck'); //
					});

					$("#edit_btn").unbind().on("click", function () {
						var obthis = getCheckboxValue("datalist");
						var len = $('input[name=datalist]:checked').length
						if (obthis != "" && len == 1) {
							ccms.util.clearForm('messageForm');
							$('#formTitle').text('修改');
							$('#save_btn').show();
							obj.edit({
								id: obthis
							});
						} else {
							ccms.dialog.notice("请选择一个活动！")
						}
					});

					$("#see_btn").unbind().on("click", function () {
						var obthis = getCheckboxValue("datalist");
						var len = $('input[name=datalist]:checked').length
						if (obthis != "" && len == 1) {
							ccms.util.clearForm('messageForm');
							$('#save_btn').hide();
							//getAjaxCall("/action/project/fitness/basic/marketcampaign/getcard?code="+obthis, false);
							obj.edit({
								id: obthis
							});
							$('#formTitle').html('查看');
						} else {
							ccms.dialog.notice("请选择一个活动！")
						}
					});

					$("#delete_btn").unbind().on("click", function () {
						var flag = true;
						var obthis = getCheckboxValue("datalist");

						var checkObj = $('input[name=datalist]:checked');
						$(checkObj).each(function () {
							if ($(this).attr('code') == 1) {
								flag = false;
							}
						})

						if (flag) {
							if (obthis != "") {
								$Dialog().confirm("确定要执行此操作吗?", function () {
									obj.del({
										id: obthis
									});
								});
							} else {
								ccms.dialog.notice("请选择活动！");
							}
						} else {
							ccms.dialog.notice("不能删除已启用活动！");
						}
					});

				}
			}).initSearchBtn().searchData(1);
		})

		function updateStatus(num) {
			var obthis = getCheckboxValue("datalist");
			var len = $('input[name=datalist]:checked').length
			var obj = $('input[name=datalist]:checked');

			if (obthis != "" && len == 1) {
				$Dialog().confirm("确定要执行此操作吗?", function () {
					if (num == 1) {
						if ($(obj).attr('expercardcode') == "" || $(obj).attr('expercardcode') == null) {
							ccms.dialog.notice("请先绑定体验卡");
							return false;
						}

						if ($('#status').val() == 1) {
							ccms.dialog.notice("同时只能开启一个活动");
							return false;
						}
					}

					var url = "${def:context}${def:actionroot}/updatestatus?id=" + obthis + "&c_status=" + num;
					ajaxCall(url, {
						method: "get",
						progress: true,
						dataType: "script",
						success: function () {
							ccms.dialog.notice("操作成功！");
							search.searchData(1);
						}
					});
				});
			} else {
				ccms.dialog.notice("请选一个活动！")
			}
		}


		function gotoReport(code, expercardcode) {
			if (expercardcode == "" || expercardcode == undefined) {
				ccms.dialog.notice("请先绑定体验卡！")
			} else {
				location.href = "${def:context}/action/project/fitness/basic/exreport/crud?code=" + code;
			}
		}

		function gotoTiyanka(code) {
			location.href = "${def:context}/action/project/fitness/basic/expercard/crud?code=" + code;
		}
	</script>
</body>

</html>