<!doctype html>
<html>
<head>
${inc:/action/project/fitness/home/pub}
<style>
</style>
<title>客服回访</title>
</head>
<body>
          <div class="modal fade dialogbg" id="select_mc"  tabindex="-1" style="height:700px ;display:none;width: 80%;margin: 0 auto;">
          	<header class="header-default">
					<span id="formTitle">分配客服</span>
					<button type="button" class="header-close" data-dismiss="modal" aria-hidden="true"></button>
				</header>
          			<div class="am-tabs-bd r-tab-cont" style="width: 100%;margin: 0 auto">
					<div class="c-n-nav-2 am-tab-panel am-in am-active am-fade three-none" >
					 	<div class="tab-cout-nav" style="margin-left:-65% ">
							<div class="tab-cout-nav-b">
								<nav class="r-c-3-t-b-l">
								</nav>
								<nav class="r-c-3-t-b-r">
									 <li>
							    		 <span>已选择会员：</span>	<span id="num"></span>
									</li>
							    	 <li>
							    	 	<button  type="button"id="Savebtn">确定</button>
									</li>		
								</nav>
							</div>
						</div>
						<div class="r-tab-cout-3-b">
							<div class="to-change-background"  ></div>
						<table> 
								<thead >
									<tr>
											<th></th>
										<th>客服姓名</th>
										<th>已分配客诉数量</th>
										<th>已处理客诉数量</th>
									</tr>
								</thead>
							<tbody  id="data" >
							</tbody>
							</table>
						</div>
					</div>
				</div>
          </div>

	<form  role="form" method="post" id="searchForm">
		<input name="sort" type="hidden" value="" preserve="true" />
		<input name="order" type="hidden" value="" preserve="true" />
		<input name="pageNo" type="hidden" value="" preserve="true" />
		<input name="totalPages" type="hidden" value="" preserve="true" />
		
		<!-- 条件筛选开始 -->
		<input id="filterconditionscolumn" type="hidden" 
		value="f_sex,f_age,f_mc,f_pt,f_stage,f_mc_status,f_pt_status,f_leave,f_calltimes,f_unfollow,f_startmonth,f_startday,f_endmonth,f_endday,f_purpose,f_participate,f_ismember,f_personalhobbit,f_marriage,f_children,f_custtype,f_returntype"/>
		<div id="filterconditionshtml">
			
		</div>
		<!-- 条件筛选结束 -->
		
		<div class="r-tab-cont">
			<div class="c-n-nav-2 am-tab-panel am-in am-active am-fade three-none" >
				<div class="r-tab-cout-3-t">
					<div class="r-tab-cout-3-t-t swgl-tk">
						<nav>
							<li class="dateTime">
						  		<input id="startdate" name="startdate" type="text" class="input-default"/>
							</li>
							<li class="dateTime">
						  		<input id="enddate" name="enddate" type="text" class="input-default"/>
							</li>
							<li>
								<select id="specialtype" name="specialtype" class="normal-select">
									<option value="">全部特殊状态</option>
									<option value="0">到访未成交</option>
									<option value="1">过期未续费</option>
									<option value="2">私教预约未成功</option>
								</select>
							</li>
							<li class="hasCheck">
								<input type="checkbox" name="thismonthtypeone" value="1"  class="r-hea-search" style="display: none;"/>本月未回访<br/>
							</li>
							<li class="hasCheck">
								<input type="checkbox" name="thismonthtypetwo" value="1"  class="r-hea-search" style="display: none;"/>本月分配<br/>
							</li>
							<div>
								<button  type="button" class="r-c-3-btn-1" id="search_btn" title="查询"></button>
								<img class="r-c-3-btn-3" src="${def:context}/js/project/fitness/image/SVG/nav/btn_shaixuan.svg" title="条件筛选" data-toggle="modal" id="filter_btn"/>
								<button type="button" class="r-c-3-btn-3" id="daochu_list" title="导出"></button>
							</div>
						</nav>
					</div>
					<div class="r-tab-cout-3-t-b">
						<nav class="r-c-3-t-b-l">
							<li>
								<button type="button" id="change_btn">分配客服</button>
							</li>
							<li>
								<button type="button" id="communicaRecord">回访</button>
							</li>
							<li id="huifangerror">
							</li>
						</nav>
						<nav class="r-c-3-t-b-r">
							<li>
								<img src="${def:context}/js/project/fitness/image/SVG/table/icon_yulan.svg" title="查看" alt=""id="look">
							</li>
						</nav>
					</div>
				</div>				
			</div>
			<div class="r-tab-cout-3-b">
				<div class="to-change-background"></div>
					<table class="">
						<thead>
							<tr>
								<th><input type="checkbox" class="selectAll" name="selectAll" id="selectAll" style="display: none;" /></th>
								<th>类型</th>
								<th>姓名</th>
								<th>性别</th>
								<th>电话</th>
								<th>客服</th>
								<th>会籍</th>
								<th>会籍最后跟进</th>
								<th>教练</th>
								<th>教练最后跟进</th>
								<th>客户特殊状态</th>
							</tr>
						</thead>
						<tbody id="datagridTemplate" style="display: none">
							<tr>
								<td>#application_id#</td>
								<td>#custtypename#</td>
								<td>#name#</td>
								<td>#sex#</td>
								<td>#mobile#</td>
								<td>#kefu#</td>
								<td>#mc#</td>
								<td>#mcdate#</td>
								<td>#pt#</td>
								<td>#ptdate#</td>
								<td>#specialtype#</td>
							</tr>
						</tbody>
						<tbody id="datagrid">
						</tbody>
					</table>
				<div class="pageDiv">
					<ul class="pagination">
					</ul>
				</div>
			</div>
		</div>
	</form>
	<form class="form-horizonta" role="form" method="post" id="updateform"
		name="updateform">
			<input type="hidden" id="mc" name="mc"/>
			<div id="gcode">
			</div>
	</form>
	<form action="${def:context}${def:actionroot}/excel" role="form" method="post" id="daochuForm" target="_blank" style="display: none">
			<input id="daochu_custtype" name="daochu_custtype" type="text" />
			<input id="daochu_specialtype" name="daochu_specialtype" type="text" />
			<input id="daochu_returntype" name="daochu_returntype" type="text" />
			<input id="daochu_thismonthtypeone" name="daochu_thismonthtypeone" type="text" />
			<input id="daochu_thismonthtypetwo" name="daochu_thismonthtypetwo" type="text" />
				<div id="daochufilterconditionshtml">
				</div>
	</form>
	<input type="hidden" name="actionroot" id="actionroot" value="${def:actionroot}" />
<script language="JavaScript">
var search = null;
$(document).ready(function() {
	ccms.util.renderCheckbox("selectAll");
	getNum();
	ccms.util.renderCheckbox("thismonthtypeone");
	ccms.util.renderCheckbox("thismonthtypetwo");
	
	//筛选条件
	var filterconditionscolumn = $("#filterconditionscolumn").val().split(",");
	var filterconditionshtml = "";
	$.each(filterconditionscolumn,function(i, val){
		filterconditionshtml+="<input name='"+val+"' id='"+val+"' type='hidden' class='filterconditions' />";
	});
	$("#filterconditionshtml").html(filterconditionshtml);
	//结束

	$(".header-close").unbind().on("click",function(){
		$("#modalAddnew").modal('hide');
	});
	searchSelectInit($("#to_mc"));
	$("#startdate").val(new Date("${def:date}").format("yyyy-MM-01")); 
	$("#enddate").val("${def:date}");
	$Dialog().date($('#startdate'));
	$Dialog().date($('#enddate'));
	 $(document).click(function(){ 
			$(".error").html("");
		 }); 
	setTimeout(function(){
		$("#select2-chosen-1").html($('.select2').find("option:selected").text());
	}, 0);
	this.search=search;
	search=$Search({datagrid:"datagrid",formId:"searchForm",success:function(){

		ccms.util.renderCheckbox("custcomm");
		//全选   取消全选
	    $("#selectAll").unbind().on("ifClicked",function(){    //点击事件未选中
		 if( $(this).prop("checked") ){// 
			$('input[name=custcomm]').iCheck('uncheck');
		 }else{
			$('input[name=custcomm]').iCheck('check');  //
		 }
	    });
		//分配客服
		$("#change_btn").unbind().on("click",function(){
			var obthis = getCheckboxValue("custcomm");
			var count = obthis.split(",").length;
			if(obthis!= ""){
				var obthis = getCheckboxValue("custcomm");
				var url = "${def:context}${def:actionroot}/returnlog?id="+obthis+"&count="+count;
				ajaxCall(url,{
				   	method: "get",
				   	progress: true,
				   	dataType: "script",
				   	success: function() {
				   		$('#num').text(count);
					}
				});
			}else{
				ccms.dialog.notice("请选择!");
			}
		});
		//分配客服
		$("#Savebtn").unbind().on("click",function(){
			//选择的客服
			var to_mc=getRadioValue("datalist2");
			if(to_mc==''||to_mc==null){
				ccms.dialog.notice("请选择客服!");
			}else{
				$("#mc").val(to_mc);
				var obthis = getCheckboxValue("custcomm");
				var val = obthis.split(",");
				var html = "";
				$.each(val, function(key, v) {
					html+="<input name='pk_value' value='"+val[key]+"' type='hidden'/>";
				});
				$('input[name="custcomm"]:checked').each(function(){ 
					html+="<input name='custtype' value='"+$(this).attr("code")+"' type='hidden'/>";
					html+="<input name='codedatatype' value='"+$(this).attr("codedatatype")+"' type='hidden'/>";
				}); 
				$("#gcode").html(html);
				$Dialog().confirm("确定要分配客服吗？",function(){
					var url = "${def:context}${def:actionroot}/allotment";
					ajaxCall(url,{
					   	method: "post",
					   	form:"updateform",
					   	progress: true,
					   	dataType: "script",
					   	success: function() {
							$Dialog().notice("分配成功！",1200,function(){
								$("#select_mc").modal('hide');
						   		search.searchData(1);
							});
						}
					});
				});
			}
		});
			
		//回访
		$("#communicaRecord").unbind().on('click',function(){
			var obthis = getCheckboxValue("custcomm");
			var count = obthis.split(",").length;
			if(obthis!= ""){
				if(count>1){
					ccms.dialog.notice("最大选择数量为1!");
				}else{
					$Dialog().confirm("确定填写回访记录吗?", function(){
						var cust_type = $("input[name=custcomm]:checked").attr("code");
						var specialtype = $("input[name=custcomm]:checked").attr("code1");
						var commurl = '${def:context}${def:actionroot}/validation?';
						if(cust_type=="0"){
							commurl+='guestcode='+obthis;
						}else{
							commurl+='customercode='+obthis;
						}
						commurl+='&cust_type='+cust_type+'&specialtype='+specialtype;
						ajaxCall(commurl,{
						   	method: "get",
						   	progress: true,
						   	dataType: "script",
						   	success: function() {
							}
						});
					});
				}
			}else{
				ccms.dialog.notice("请选择!");
			}
		});
	}}).initSearchBtn().searchData(1);
	$('#look').on('click',function(){
		var obthis = getCheckboxValue("custcomm");
		var count = obthis.split(",").length;
		if(obthis!= ""){
			if(count>1){
				ccms.dialog.alert("只能选择一条记录！");
				return false;
			}
			var type = $("input[name=custcomm]:checked").attr("code2");
			var customercode = "";
			var guestcode = "";
			if(type=="1"){
				customercode = obthis;
			}else{
				guestcode = obthis;
			}
			ccms.dialog.open({url : '${def:context}/action/project/fitness/guest/follow/custcomm?'
					+'cust_type=1&type=1&commtype='+1+'&customercode='+customercode+"&status=&guestcode="+guestcode,width:1200,height:700});
		}else{
			ccms.dialog.notice("请选择!");
		}
	});

	//导出
	$("#daochu_list").unbind().on("click", function(){
         $("#daochu_custtype").val($("#custtype").val());
         $("#daochu_specialtype").val($("#specialtype").val());
         $("#daochu_returntype").val($("#returntype").val());
         $("#daochu_thismonthtypeone").val($("#thismonthtypeone").val());
         $("#daochu_thismonthtypetwo").val($("#thismonthtypetwo").val());
         $("#daochu_startdate").val($("#startdate").val());
         $("#daochu_enddate").val($("#enddate").val());

     	var filterconditionscolumn = $("#filterconditionscolumn").val().split(",");
     	var daochufilterconditionshtml = "";
     	$.each(filterconditionscolumn,function(i, val){
     		daochufilterconditionshtml+="<input name='daochu_"+val+"' id='daochu_"+val+"' value='"+$("#"+val).val()+"' type='text' class='filterconditions' />";
     	});
     	$("#daochufilterconditionshtml").html(daochufilterconditionshtml);
         $("#daochuForm").submit();
    });	
	selectInit($("#custtype,#specialtype,#returntype"));
}) 

	//条件筛选
	$("#filter_btn").unbind().on('click',function(){
		ccms.dialog.open({url : "${def:context}${def:actionroot}/filter", width:1000, height:650});
	})
	
	function getNum(){
		var url = "${def:context}${def:actionroot}/getnum";
		ajaxCall(url,{
		   	method: "get",
		   	progress: true,
		   	dataType: "script",
		   	success: function() {
			}
		});
	}
	
</script>
</body>
</html>