<!DOCTYPE html>
<html>
<head>
${inc:/action/project/fitness/home/pub}
<title>会员分配及跟进</title>
</head>
<body >
		<!--addnew/edit form-->
		<div class="modal fade " id="modalAddnew1"  tabindex="-1" style="display:none;" >
		<div class="basic-information modal-dialog dialogbg" >
				<header class="header-default">
					<span id="formTitle">查看</span>
					<span class="header-close"></span>
				</header>
				<div class="b-i-main yyc_b-i-main">
					<form id="addForm" name="addForm" method="post">
					<input type="hidden" id="cc_code" name="cc_code" value=""/>
					<input type="hidden" id="cus_code" name="cus_code" value=""/>
			    	<aside style="float: left">
						<p>
							<img src="${def:context}/js/project/fitness/image/SVG/170X220.svg">
							<span></span>
						</p>
					</aside>
					<nav>
						<li>
							<label>姓名</label>
							<input type="text" id="cc_name" name="cc_name" value="" maxlength="80"/>
						</li>
						<li> 			
							<label>性别</label>
							<div class="my-selected">
								<select  id="cc_sex" name="cc_sex" class="normal-select"> 
									<option value="">未填</option>
									<option value="1">男</option>
									<option value="0">女</option>
								</select>
							</div> 	
			 			 </li>
						<li> 			
							<label>手机</label> 	
							<input type="text" id="cc_mobile" name="cc_mobile" value="" maxlength="80" />
			 			</li>	
						<li></li>
						<li >
						<label>生日</label>
							<select  id="cc_birth" name="cc_birth" class="normal-select"> 
								<option value="">请选择月</option>
								<month>
									<option value="${fld:domain_value}">${fld:domain_text_cn}</option>
								</month>
							</select>
						</li>
						<li>
							<label></label>
							<select  id="cc_day" name="cc_day" class="normal-select"> 
								<option value="">请选择日</option>
								<day>
								<option value="${fld:domain_value}">${fld:domain_text_cn}</option>
								</day>
							</select>
						</li>
						<li >
							<label>微信</label>
							<input type="text" id="cc_wx" name="cc_wx" value="" maxlength="80"/>
						</li>
						<li> 			
							<label>qq</label> 	
							<input type="text" id="cc_qq" name="cc_qq" value="" maxlength="80" />
			 			</li>	
			 			<li> 			
							<label>E-mail</label> 	
							<input type="text" id="cc_email" name="cc_email" value="" maxlength="80" />
			 			</li>	
			 			 				
						<li> 			
							<label>年龄范围</label> 	
							<div class="my-selected">
								<select  id="cc_age" name="cc_age" class="normal-select"> 
									<option value="">未填</option>
									<age>
									<option value="${fld:domain_value}">${fld:domain_text_cn}</option>
									</age>
								</select>
							</div> 
		 			 	</li>						
						<li> 			
							<label>会籍</label> 	
							<div class="my-selected">
								<select  id="cc_mc" name="cc_mc"   >
											<staff-rows3>
												<option value="${fld:userlogin}">${fld:name}</option>
											</staff-rows3>
									</select>
							</div> 
			 			</li>
						<li> 			
							<label>获客渠道</label> 	
							<div class="my-selected">
								<select  id="cc_type" name="cc_type" class="normal-select"> 
									<guesttype-rows>
										<option value="${fld:vc_topic}">${fld:vc_content}</option>
									</guesttype-rows>
								</select>
							</div> 
			 			</li>	
						<li> 			
							<label>推荐人</label> 	
							<input  readonly="readonly" type="text" id="recommend" name="recommend" value="" maxlength="80" />
			 			</li>
						<li> 			
							<label>证件类型</label> 	
							<div class="my-selected">
								<select  id="cc_cardtype" name="cc_cardtype" class="normal-select"> 
									<option value="">未填</option>
									<option value="0">身份证</option>
									<option value="1">驾驶证</option>
									<option value="2">其他</option>
								</select>
							</div> 
			 			 </li>		 	
			 			 <li> 			
							<label>证件号码</label> 	
							<input type="text" id="cc_card" name="cc_card" value="" maxlength="80" />
			 			 </li>			 			 
			 			 <li> 			
							<label>国籍</label> 	
							<div class="my-selected">
								<select  id="cc_nationality" name="cc_nationality"   class="normal-select"> 
									<option value="0"  >中国</option>
								</select>
							</div>
			 			 </li>	
			 			 <li> 			
							<label>民族</label> 	
							<div class="my-selected">
								<select  id="cc_nation" name="cc_nation" class="normal-select"> 
									<option value="">未填</option>
									<nation>
											<option value="${fld:vc_topic}">${fld:vc_content}</option>
									</nation>
								</select>
							</div>
			 			 </li>				 			
			 			<li> 			
							<label>职业</label> 	
							<input type="text" id="cc_occupation" name="cc_occupation" value="" maxlength="80" />
			 			 </li>			 			 
				 		<li> 			
							<label>家庭住址</label> 	
							<div class="my-selected">
								<select  id="province" name="province" class="normal-select"> 
									<option value="">请选择省</option>
								</select>
							</div>
					 	</li>		
				 		<li> 			
							<label>市</label> 	
							<div class="my-selected">
								<select  id="city" name="city" class="normal-select"> 
									<option value="">请选择市</option>
								</select>
							</div>
					 	</li>						 
			 			<li> 			
							<label>家庭详细地址</label> 	
							<input type="text" id="cc_addr" name="cc_addr" value="" maxlength="80" />
			 			</li>		
			 		 	<li></li>
			 			<li> 			
							<label>公司名称</label> 	
							<input type="text" id="cc_officename" name="cc_officename" value="" maxlength="80" />
			 			</li>
			 			<li> 			
							<label>公司电话</label> 	
							<input type="text" id="cc_officetel" name="cc_officetel" value="" maxlength="80" />
			 			</li>			 			 
				 		<li> 			
							<label>公司地址</label> 	
							<div class="my-selected">
								<select  id="province2" name="province2" class="normal-select"> 
									<option value="">请选择省</option>
								</select>
							</div>
					 	</li>		
				 		<li> 			
							<label>市</label> 	
							<div class="my-selected">
								<select  id="city2" name="city2" class="normal-select"> 
									<option value="">请选择市</option>
								</select>
							</div>
					 	</li>			
		 			 	<li> 			
							<label>公司详细地址</label> 	
							<input type="text" id="cc_officeaddr" name="cc_officeaddr" value="" maxlength="80" />
			 			 </li>				 			 		 	
			 			 <li></li>
			 			 <li> 			
							<label>紧急联系人</label> 	
							<input type="text" id="cc_urgent" name="cc_urgent" value="" maxlength="80" />
			 			 </li>	
			 			 <li> 			
							<label>联系人电话</label> 	
							<input type="text" id="cc_othertel" name="cc_othertel" value="" maxlength="80" />
			 			 </li>
				 		<li> 			
							<label>健身目的</label> 	
							<div class="my-selected">
								<select  id="cc_purpose" name="cc_purpose" class="normal-select"> 
									<option value="">未填</option>
										<fitnessPurpose>
												<option value="${fld:vc_topic}">${fld:vc_content}</option>
										</fitnessPurpose>
								</select>
							</div>
					 	</li>		
				 		<li> 			
							<label>离开原因</label> 	
							<div class="my-selected">
								<select  id="cc_leave" name="cc_leave" class="normal-select"> 
									<option value="">请选择</option>
									<leave>
										<option value="${fld:domain_value}">${fld:domain_text_cn}</option>
									</leave>
								</select>
							</div>
					 	</li>					 			 
				 		<li> 			
							<label>获取咨询习惯</label> 	
							<div class="my-selected">
								<select  id="cc_gethobbit" name="cc_gethobbit" class="normal-select"> 
									<option value="">未填</option>
									<consultingHabit>
											<option value="${fld:vc_topic}">${fld:vc_content}</option>
									</consultingHabit>
								</select>
							</div>
						</li>					 			 
				 		<li> 			
							<label>个人爱好</label> 	
							<div class="my-selected">
								<select  id="cc_personalhobbit" name="cc_personalhobbit" class="normal-select"> 
									<option value="">未填</option>
									<personalHobbies>
											<option value="${fld:vc_topic}">${fld:vc_content}</option>
									</personalHobbies>
								</select>
							</div>
					 	</li>		
				 		<li> 			
							<label>子女情况</label> 	
							<div class="my-selected">
								<select  id="cc_children" name="cc_children" class="normal-select"> 
									<option value="">未填</option>
									<children>
										<option value="${fld:domain_value}">${fld:domain_text_cn}</option>
									</children>
								</select>
							</div>
					 	</li>						 
				 		<li> 			
							<label>婚姻情况</label> 	
							<select id="cc_marriage" name="cc_marriage" class="normal-select"> 
								<option value="">未填</option>
								<mariy>
									<option value="${fld:domain_value}">${fld:domain_text_cn}</option>
								</mariy>
							</select>
					 	</li>						 
			 			<li class="to100w" >
							<label>备注</label>
							<textarea id="cc_remark" name="cc_remark" placeholder="暂无数据" class="my-textarea" rows="" cols="4"></textarea>
						</li>	
					</nav>
					</form>
				</div>
			</div>
		</div>		

	<!-- 会籍分配所用form -->
		<form class="form-horizonta" role="form" method="post" id="udpatemcform"
			name="udpatemcform">
				<input id="cust_mc" name="cust_mc"  type="hidden"/>
				<div id="customercode">
				</div>
		</form>
<!--会员留言-->
      <div class="modal fade" id="myModalLabel"  tabindex="-1" style="display:none;">
		<div class="basic-information modal-dialog dialogbg">
				<header class="header-default">
					<span id="formTitle">会员留言</span>
				<span class="header-close" onclick="$('.close').click()"></span> <!--关闭按钮无效，调用函数触发旧按钮点击事件-->
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true" style='display:none;'>&times;</button>
				</header>
				<form id="messageForm" name="messageForm" method="post">
					<div class="b-i-main">
						<input type="hidden" id="vc_code" name="vc_code" value=""/>
						<nav>
							<li class="to100w" >
								<label>会员留言</label>
								<textarea  style="width: 600px;background: rgb(42, 48, 56)" id="mc_message" name="" placeholder="暂无数据" class="my-textarea" rows="" cols="4"></textarea>
							</li> 
						</nav>
					</div>
				<footer class="footer-default">
					<button id="save_message" type="button">保存</button>
				</footer>
				</form>
			</div>
		</div>
		<form  role="form" method="post" id="searchForm">
				<input name="sort" type="hidden" value="mc_code" preserve="true" />
				<input name="order" type="hidden" value="desc" preserve="true" />
				<input name="pageNo" type="hidden" value="" preserve="true" />
				<input name="totalPages" type="hidden" value="" preserve="true" />
				
				<!-- 条件筛选开始 -->
				<input id="filterconditionscolumn" type="hidden" 
				value="f_pt,f_cardtype,f_status,f_sex,f_age,f_nofollowstartdate,f_nofollowenddate,f_entrystartdate,f_entryenddate,f_startmonth,f_startday,f_endmonth,f_endday,f_genjintype,f_type,f_mc,f_level,f_purpose,f_stage,f_personalhobbit,f_marriage,f_children,f_leave,f_participate,f_ismember,f_protection,f_calltimes,f_distributioncount"/>
				<div id="filterconditionshtml">
				</div>
				<div class="am-tabs-bd r-tab-cont">
					<div class="c-n-nav-2 am-tab-panel am-in am-active am-fade three-none" >
						<div class="tab-cout-nav">
							<div class="tab-cout-nav-t yyc_tab-cout-nav-t">
								<nav class="tab-nav-my">
					 			 	<li class="dateTime">
										<input id="_start_date" name="_start_date" type="text" class="input-default"/>
									</li>
									<li class="dateTime">
										<input id="_end_date" name="_end_date" type="text"class="input-default"/>
									</li>
					 			 	<li class="inputName">
										<input type="text" id="vc_all" name="vc_all" placeholder="姓名/电话/卡号" class="input-default"/>							
					 			 	</li>	
									<li class="hasRadio"> 
										<input type="checkbox" name="thismonthcustone" value="1" style="display: none;"/>本月新增
									</li>
									<li class="hasRadio">
										<input type="checkbox" name="thismonthcusttwo" value="2" style="display: none;"/>本月分配
									</li>
									<li class="hasRadio">
										<input type="checkbox" name="thismonthcustthree" value="3" style="display: none;"/>本月未跟进
									</li>
									<div class="r-c-btnList b-10">
										<button type="button" class="r-c-3-btn-1" id="search_btn" title="查询"></button>
										<button type="button" class="r-c-3-btn-2" id="filter_btn" title="条件筛选"></button>
										 <button type="button"  class="r-c-3-btn-3" id="daochu_list" title="导出"></button>
									</div>
								</nav>
							</div>
							<div class="tab-cout-nav-b">
								<nav class="r-c-3-t-b-l">
									<li>
							    	 	<button  type="button"id="change_btn">会籍分配</button>
									</li>
							    	 <li>
							    	 	<button  type="button"id="communicaRecord">跟进</button>
									</li>	
							    	<!--  <li>
							    	 	<button  type="button"id="speak_btn">会员留言</button>
									</li> -->	
								</nav>
								<nav class="r-c-3-t-b-r">			
										
									<li>
										<img src="${def:context}/js/project/fitness/image/SVG/table/icon_yulan.svg" title="查看" alt=""id="see">
									</li>
									<li>
										<img src="${def:context}/js/project/fitness/image/SVG/btn/qiangziyuan.svg" title="抢资源" alt=""id="snatch_btn">
									</li>					
								</nav>
							</div>
						</div>
						<div class="r-tab-cout-3-b">
							<div class="to-change-background h-43"></div>
							<table> 
								<thead>
									<tr>
										<th class="table-checkbox">
											<label class="am-checkbox">
												<input id="selectAll"  name="datalist"  type="checkbox" value="" style="display: none;">
											</label>
										</th>
										<th>照片</th>
										<th>会员号</th>
										<th>公海</th>
										<th>姓名</th>
										<th>性别</th>	
										<th>手机</th>
										<th>年龄</th>
										<th>会籍</th>
										<th>入会日期</th>
										<th>到期日期</th>										
										<th>沟通次数</th>	
										<th>最新沟通日期</th>								
									</tr>
								</thead>
								
								<tbody id="datagridTemplate" style="display: none">
									<tr>
										 <td class="table-checkbox">#application#</td> 
										<td>
											<div class="hoverToshow" style="position: relative;display: flex; align-items: center;justify-content: center;">
												<img src="#imgpath#"  height="50" width="50">
												<div class="hoverhowTable"  style="position: absolute;top: 0;width: 50px; height: 50px;background: rgba(42，48，56,.5);display: none; align-items: center;justify-content: center;">
													<img onclick="pictures('#mc_code#')" src="${def:context}/js/project/fitness/image/SVG/paizhao.svg">
												</div>
											</div>
										</td>
										<td >#mc_code#</td>
										<td >#ispublic#</td>
										<td >#mc_name#</td>
										<td >#i_sex#</td>	
										
										<td >#mobile#</td>
										<td >#age#</td>
										<td >#vc_mc#</td>
										<td >#indate#</td>		
										
										<td >#enddate#</td>
										<td >#com_count#</td>
										<td >#com_date#</td>		
									</tr>
								</tbody>
								<tbody id="datagrid">
								</tbody>
							</table>
							<div class="pageDiv">
								<ul class="pagination">
								</ul>
							</div>
						</div>
					</div>
				</div>
			</form>
			<form action="${def:context}${def:actionroot}/excel" role="form" method="post" id="daochuForm" target="_blank" style="display: none">
				<input id="daochu_start_date" name="daochu_start_date" type="text"/>
				<input id="daochu_end_date" name="daochu_end_date" type="text"/>
				<input id="daochu_vc_all"  name="daochu_vc_all" type="text"/>
				<input id="daochu_thismonthcustone"  name="daochu_thismonthcustone" type="text"/>
				<input id="daochu_thismonthcusttwo"  name="daochu_thismonthcusttwo" type="text"/>
				<input id="daochu_thismonthcustthree"  name="daochu_thismonthcustthree" type="text"/>
				<div id="daochufilterconditionshtml">
				</div>
			</form>
	<input type="hidden" name="actionroot" id="actionroot" value="${def:actionroot}" />
	<script language="JavaScript">
	var search2=null;
	var init_event_city;
	var init_event_city2;
$(document).ready(function() {

	//筛选条件
	var filterconditionscolumn = $("#filterconditionscolumn").val().split(",");
	var filterconditionshtml = "";
	$.each(filterconditionscolumn,function(i, val){
		filterconditionshtml+="<input name='"+val+"' id='"+val+"' type='hidden' class='filterconditions' />";
	});
	$("#filterconditionshtml").html(filterconditionshtml);
	//结束
	
	$('#cc_mc').attr('disabled',true);
	searchSelectInit($("#cc_mc,#skill_name"));

	ccms.util.renderCheckbox("thismonthcustone");	
	ccms.util.renderCheckbox("thismonthcusttwo");	
	ccms.util.renderCheckbox("thismonthcustthree");	
	
	$(".header-close").unbind().on("click",function(){
		$("#modalAddnew1").modal('hide');
		ccms.util.clearForm('addForm');
		$("#myModalLabel").modal('hide');
		ccms.util.clearForm('messageForm');
	});
	
	$Dialog().date($('#_start_date'));
	$Dialog().date($('#_end_date'));
	$("#_start_date").val(new Date().format("yyyy-MM-01"));
	$("#_end_date").val("${def:date}");
	
	$("#see").unbind().on("click",function(){
		var code=$('input[name="datalist"]:checked').val();
		var len=$('input[name="datalist"]:checked').length;
		if(code==""||len!=1){
			ccms.dialog.alert("请选择一条记录");
		}else{
			top.ccms.dialog.open({url : '${def:context}/action/project/fitness/guest/follow/custcomm?cust_type=1&type=1&commtype='+1+'&customercode='+code+"&status=",width:1200,height:700});
		}
	});
	//会员留言
	$("#speak_btn").unbind().on("click",function(){
 		var code=$('input[name="datalist"]:checked').val();
		if(code==''||code==null){
			ccms.dialog.alert("请选择会员进行留言！")
		}else{   
			$("#myModalLabel").modal('show')
		}
	});
	
	//会籍分配
	$("#change_btn").unbind().on("click",function(){
		var customercodes =  getCheckboxValue("datalist");
		if(customercodes==""){
			ccms.dialog.alert("请选择会员进行操作");
		}else{
			ccms.dialog.open({url : '${def:context}${def:actionroot}/distribution/crud?customercode='+customercodes, width:'1000',height:'600'});
		}
	});

	//筛选
	$("#saixuan").click(function(){
		$("#modalAddnew").modal('show')
	})
	//确认留言
	$("#save_message").click(function(){
		insertMsg();
	})	
	
	
	//跟进
	$("#communicaRecord").unbind().on('click',function(){
		var code=$('input[name="datalist"]:checked').val();
		var len=$('input[name="datalist"]:checked').length;
		if(code==""||len!=1){
			ccms.dialog.alert("请选择一条记录");
		}else{
			var countgh = 0;
			$("input[name=datalist]:checked").each(function(date){
				//公海数据类型：1资源2公海
				if($(this).attr("code2")=="1"){
					countgh++;
				}
			});
			if(len!=countgh){
				ccms.dialog.alert("公海资源不能跟进，请确认！");
				return false;
			}
			top.ccms.dialog.open({url : '${def:context}${def:actionroot}/custcomm?customercode='+code+'&cust_type=1', width:'1170',height:'600'});

		}
	});
	//导出
	$("#daochu_list").unbind().on("click", function(){
		$("#daochu_start_date").val($("#_start_date").val());
		$("#daochu_end_date").val($("#_end_date").val());
		$("#daochu_vc_all").val($("#vc_all").val());
		$("#daochu_thismonthcustone").val($("input[name=thismonthcustone]:checked").val());
		$("#daochu_thismonthcusttwo").val($("input[name=thismonthcusttwo]:checked").val());
		$("#daochu_thismonthcustthree").val($("input[name=thismonthcustthree]:checked").val());
		
		//筛选导出条件开始
     	var filterconditionscolumn = $("#filterconditionscolumn").val().split(",");
     	var daochufilterconditionshtml = "";
     	$.each(filterconditionscolumn,function(i, val){
     		daochufilterconditionshtml+="<input name='daochu_"+val+"' id='daochu_"+val+"' value='"+$("#"+val).val()+"' type='text' class='filterconditions' />";
     	});
     	$("#daochufilterconditionshtml").html(daochufilterconditionshtml);
		//筛选导出条件结束
		$("#daochuForm").submit();
	}); 
	
	//条件筛选
	$("#filter_btn").unbind().on('click',function(){
		ccms.dialog.open({url : "${def:context}${def:actionroot}/filter", width:1000, height:670});
	})
 	getSelectDomain("province", "Province");
	$("#province").change(function(){
	    getSelectDomain("city", "City", "Province", $(this).val(),function(){
        		document.addForm.city.value = init_event_city;
        });
	});
	$("#city").change(function(){
		getSelectDomain("region", "Region", "City", $(this).val());
	}); 
	
	getSelectDomain("province2", "Province");
	$("#province2").change(function(){
		getSelectDomain("city2", "City", "Province", $(this).val(),function(){
        		document.addForm.city2.value = init_event_city2;
        });
	});
	$("#city2").change(function(){
		getSelectDomain("region2", "Region", "City", $(this).val());
	}); 
	
	if( "all" != "${fld:datetype}" ){
		var time = new Date().format("yyyy-MM-dd");
		time=time.substring(0,8);
		time+='01'
		$("#_start_date").val(time);
		$("#_end_date").val("${def:date}");
	}
	this.search2=search2;
	search=$Search({datagrid:"datagrid",formId:"searchForm",rowpackage:function(obj){
		if( "" != obj.imgid ){
			obj.imgpath = "${def:context}/action/project/fitness/util/attachment/download?tuid="+obj.imgid+"&type=1";
		}else{
			obj.imgpath = "${def:context}/js/project/fitness/image/SVG/50X50.svg";
		}
	},success:function(){
		$("#searchForm #vc_all").val("");
		ccms.util.renderCheckbox("datalist");
		//全选
		$("#selectAll").unbind().on("ifClicked",function(){    
			 if( $(this).prop("checked") ){// 
				$('input[name=datalist]').iCheck('uncheck');
			 }else{
				$('input[name=datalist]').iCheck('check');  //
			 }
	   });
	}}).initSearchBtn().searchData(1);

		//抢资源
		$("#snatch_btn").unbind().on("click", function(){
			var obthis = getCheckboxValue("datalist");
			var count = obthis.split(",").length;
			if(obthis!= ""){
				var countgh = 0;
				$("input[name=datalist]:checked").each(function(date){
					//公海数据类型：1会员  2公海
					if($(this).attr("code2")=="2"){
						countgh++;
					}
				});
				if(count!=countgh){
					ccms.dialog.alert("抢资源只能选择公海数据！");
					return false;
				}
				$Dialog().confirm("选定的"+count+"个公海资源，是否继续！",function(){
					var url="${def:actionroot}/updatepublic?id="+obthis;
					ajaxCall(url,{
						method: "get",
						progress: true,
						dataType: "script",
						success: function() {
						}
				    });
				});
			}else{
				ccms.dialog.notice("请选择会员!");
			} 
		})
		searchSelectInit($("#cc_sex,#cc_birth,#cc_day,#cc_age,#cc_type,#cc_cardtype,#cc_nationality,#province,#city,#province2,#city2,#cc_purpose,#cc_leave,#cc_gethobbit,#cc_personalhobbit,#cc_children,#cc_marriage,#vc_cardtype,#skill_name,#i_status"))
})

function insertMsg(){
	var divobj = $("#checkedNodesDiv");
	var codes=$('input[name=datalist]');
	var mc_message=$('#mc_message').val();
	divobj.empty();
	for(var i = 0; i < codes.length; i++){
		var obj = codes[i].value;
    	divobj.append('<input type="hidden" name="mc_code" value="' + obj + '" />');
    	divobj.append('<input type="hidden" name="mc_message" value="' + mc_message + '" />');
	}
	var uri="${def:context}/action/project/fitness/customer/memberinfo/insertmsg";
	   ajaxCall(uri,{
		   	method: "post",
		   	form:"messageForm",
		   	progress: false,
		   	dataType: "script",
		   	success: function() {
		   		ccms.dialog.alert("留言成功！")
		   		$('#myModalLabel').modal('hide');
		   		$('#mc_message').val('');
		   		search.searchData(1);
		   		}
		   	}); 
}
//拍照
function pictures(code){
	ccms.dialog.open({url: contextPath+"/action/project/fitness/util/attachment/photo/crud?table_code=cc_customer&pk_value="+code, height: "600", width: "630"});
}
</script>
</body>
</html>