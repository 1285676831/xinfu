<!DOCTYPE html>
<html>
<head>
${inc:/action/project/fitness/home/pub}
<title>充值、退费</title>
</head>
<body>
<!--addnew/edit form-->
<div class="modal fade" id="modalAddnew"  tabindex="-1" style="display:none;">
		<div class="basic-information modal-dialog dialogbg" >
				<header class="header-default">
					<span id="formTitle"></span>
					<span class="header-close"></span>
				</header>
			<form id="formEditor" name="formEditor" class="form-horizontal" role="form" method="post">
				<input type="hidden" id="vc_code" name="vc_code" value="" />
				<input type="hidden" id="cust_code" name="cust_code" value="" />
	          	<div class="modal-body b-i-main">
					<nav>
						<li>
							<label style="width: 130px;">会员号/姓名/手机：</label>
							<input type="text" id="cust" name="cust" value="" placeholder="会员号/姓名/手机号"/>
						</li>
						<li>
							<label style="width: 100px;">姓名：</label>
							<input type="text" id="name" name="name" value="" readonly="readonly" placeholder="姓名"/>
						</li>
						<li>
							<label style="width: 130px;">储值金额：</label>	
							<span id="czmoeny"></span>
						</li>
					<!-- 	modified by zzn 2019-05-27 注释掉
						<li>
							<label style="width: 100px;">运动基金：</label>		
							<span id="ydmoeny"></span>
						</li> 
					-->
						<li>
							<label style="width: 100px;">有效期限：</label>	
							<span id="enddate"></span>
						</li>
						<li>
							<label style="width: 130px;">最大退费金额：</label>			
							<span id="tuifeimoney"></span>
						</li>
						<li>
							<label style="width: 100px;">退费原因：</label>	
							<input type="text" id="refund_reason" name="refund_reason" value="0" placeholder="退费原因"/>
						</li>
						<li>
							<label style="width: 130px;" id="ctmoney">充值金额：</label>	
							<input type="text" id="moneycash" name="moneycash" value="0" placeholder="金额"/>
						</li>
						
						<li>
							<label style="width: 130px;">赠送运动基金：</label>	
							<input type="text" id="moneygift" name="moneygift" value="0" placeholder="赠送运动基金"/>
						</li>
						 
						<li></li>
						<li class="to100w" style="margin-left: 6%">
							<label style="width: 100px;">备注：</label>	
							<textarea id="remark" cols="55" class="my-textarea" placeholder="备注"rows="3" name="remark" ></textarea>
						</li>
					</nav>
				</div>
				<div id="i_paytypeone" >
	          		<div class="modal-body " id="paymoney" style="margin-left: 6%;height: 30px"  >
					</div>
	          		<div class="modal-body b-i-main">
						<nav>
							<li>
								<label style="width: 130px;">支付方式：</label>
								<select id="moneytype" class="normal-select">
									<option value="">请选择</option>
									<OtherPayWay-list>
										<option value="${fld:cnfg_id}">${fld:vc_content}</option>
									</OtherPayWay-list>
								</select>
								<label style="width: 160px;">金额：</label>
								<input type="text" id="money" name="money" placeholder="金额" />
								&nbsp;
								<i class="am-icon-plus" id="addmoney" title="添加"></i>
							</li>
						</nav>
					</div>
					<input type="hidden" id="pay_detail" name="pay_detail"/>
						<input type="hidden" id="fushu" name="fushu"/>
				</div>
				
			<footer class="footer-default" style="margin-top: 20px">
   				<button type="button" id="save_btn" style="display: none;">确认收款</button>
   				<button type="button" id="refund_btn" style="display: none;">确认退款</button>
			</footer>
			</form>
		</div>
	</div>
</div> 

	<form role="form" method="post" id="searchForm">
        <input name="sort" type="hidden" value="c.created" preserve="true" />
		<input name="order" type="hidden" value="desc" preserve="true" />
		<input name="pageNo" type="hidden" value="" preserve="true" />
		<input name="totalPages" type="hidden" value="" preserve="true" />
		<div class="r-tab-cont " style="height: 500px">
			<div class="c-n-nav-2 am-tab-panel am-in am-active am-fade three-none" >
				<div class="r-tab-cout-3-t">
					<div class="r-tab-cout-3-t-t swgl-cz">
						<nav>
							<li class="dateTime">
					  			<input id="c_startdate" name="c_startdate" type="text" class="input-default"/>
					  		</li>
					  		
					  		  <li class="dateTime">
								<input id="c_enddate" name="c_enddate" type="text" class="input-default"/>
							</li>
					  		
							<li style="width: 90px;">
								<select id="recharge_type" name="recharge_type" class="normal-select">
									<option value="">全部类型</option>
									<option value="1">充值</option>
									<option value="2">退费</option>
								</select>
							  </li>
							  <li class="inputName" style="width: 170px;">
									<input id="cust" name="cust" type="text" placeholder="会员号/姓名/手机号" class="input-default"/>
								</li>
							<li class="w-120">
									<input id="minmoney" name="minmoney" type="text" placeholder="最小储值金额" class="input-default"/>
								  </li>
								<li class="w-120">
								<input id="maxmoney" name="maxmoney" type="text" placeholder="最大储值金额" class="input-default"/>
								</li>
						  <div>
								<button type="button" class="r-c-3-btn-1" id="search_btn"  title="查询"></button>
								<img src="${def:context}/js/project/fitness/image/SVG/btn/btn_chongzhi.svg" alt="" title="充值" data-toggle="modal" id="addnew_btn">
								<img src="${def:context}/js/project/fitness/image/SVG/btn/btn_tuikuan.svg" alt="" title="退费" data-toggle="modal" id="update_btn">
								<button type="button" class="r-c-3-btn-3" id="daochu_list"  title="导出"></button>
							</div>
								
				  		</nav>
				  	</div>
					<div class="r-tab-cout-3-t-b">
					<nav class="r-c-3-t-b-l">
					</nav>
					<nav class="r-c-3-t-b-r">
						<li>
							<img src="${def:context}/js/project/fitness/image/SVG/table/icon_yulan.svg" title="查看" alt=""id="preview">
						</li>
						<li>
							<img src="${def:context}/js/project/fitness/image/SVG/nav/dayin.svg" title="打印小票" alt=""id="print_ticket_btn">
						</li>
					</nav>
				</div>
				</div>				
			</div>
			<div class="r-tab-cout-3-b">
				<div class="to-change-background"></div>
					<table class="">
						<thead>
							<tr>
								<th></th>
							    <th>操作类型</th>				
								<th>会员编号</th>
							    <th>姓名</th>		
							    <th>本次充值金额</th>
							  	 <th>本次赠送金额</th>
							    <th>当前金额</th>
							    <th>已退费金额</th>
								<th>操作人</th>
								<th>操作时间</th>
							</tr>
						</thead>
						<tbody id="datagridTemplate" style="display:none">
							<tr>	
								<td>#checklink#</td>		
				                <td>#recharge_type#</td>		
				                <td>#customercode#</td>	
				                <td>#name#</td>
		 					    <td>#factmoney#</td>
				               	<td>#givemoney#</td>			
				                <td>#moneycash#</td>		
				                <td>#refund#</td>
				                <td>#createdby#</td>
				                <td>#created#</td>
							</tr>
						</tbody>
						<tbody id="datagrid">
						</tbody>
					</table>
				<div class="pageDiv">
					<ul class="pagination">
					</ul>
				</div>
			</div>
		</div>
	</form>
	<form action="${def:context}${def:actionroot}/excel" role="form" method="post" id="daochuForm" target="_blank" style="display: none">
			<input id="daochu_c_startdate" name="daochu_c_startdate" type="text" />
			<input id="daochu_c_enddate" name="daochu_c_enddate"text" />
			<input id="daochu_cust" name="daochu_cust" type="text" />
			<input id="daochu_minmoney" name="daochu_minmoney" type="text" />
			<input id="daochu_maxmoney" name="daochu_maxmoney" type="text" />
			<input id="daochu_recharge_type" name="daochu_recharge_type" type="text" />
	</form>
	<input type="hidden" name="actionroot" id="actionroot" value="${def:actionroot}" />
<script language="JavaScript">
var search=null;
$(document).ready(function() {
	//判断该登录人是否有收款权限
	if(parseInt("${fld:skillscopenum}")>0){
		$("#refund_btn,#save_btn").show();
	}
	$(".header-close").unbind().on("click",function(){
		$("#modalAddnew").modal('hide');
		ccms.util.clearForm('formEditor');
	});
	 selectInit($("#moneytype")); 
	
	$("#c_startdate").val(new Date("${def:date}").format("yyyy-MM-01")); 
	$("#c_enddate").val("${def:date}");
	$Dialog().date($('#c_startdate'));
	$Dialog().date($('#c_enddate'));
	 $(document).click(function(){ 
		$(".error").html("");
	 }); 
		var obj = $Crud({
			formId:"formEditor",
			button:"save_btn",
			bpkField:"vc_code",
			insertBack:function(){
				search.searchData();
			},
			updateBack:function(){
				search.searchData();
			},
			deleteBack:function(){
				search.searchData();
			},
			addNewBack:function(){
				$("#paymoney,#ydmoeny,#czmoeny,#enddate").html("");
				$("#refund_reason,#tuifeimoney").parent().hide();
				$("#ctmoney").html("充值金额：");
				$("#moneycash").attr("placeholder", "充值金额");
				$("#moneygift").parent().show();
				$("#refund_btn").hide();
				//判断该登录人是否有收款权限
				if(parseInt("${fld:skillscopenum}")>0){
					$("#save_btn").show();
				}
				$("#cust").attr("readonly", false);
				$("#formTitle").html("充值");
			},
			editBack:function(){
				$("#refund_reason,#tuifeimoney").parent().show();
				$("#moneygift").parent().hide();
				$("#paymoney").html("");
				$("#ctmoney").html("退费金额：");
				$("#moneycash").attr("placeholder", "退费金额");
				$("#cust").attr("readonly", true);
				$("#save_btn").hide();
				//判断该登录人是否有收款权限
				if(parseInt("${fld:skillscopenum}")>0){
					$("#refund_btn").show();
				}
				$("#formTitle").html("退费");
			},
			validate:function(){
				var flag=$("#formEditor").validate({
					rules : {
				    
					},
				messages: {
					
				}
			});
				return flag;
			},
			check:function(){
			}
		}).init();
	this.search=search;
	search=$Search({datagrid:"datagrid",formId:"searchForm",success:function(){
		$("#searchForm #cust").val("");
		$("#update_btn").unbind().on("click", function(){
			var obthis = getCheckboxValue("recharge");
			var code = $("input[name=recharge]:checked").attr("code");
			if(code=="0"){
				ccms.dialog.alert("退费记录不能操作!");
				return false;
			}
			var count = obthis.split(",").length;
			if(obthis!= ""){
				setSelectValue($("#moneytype"), "")
				obj.edit({id:obthis});
			}else{
				ccms.dialog.alert("请选择!");
			}
		});
		ccms.util.renderRadio("recharge");
	}}).initSearchBtn().searchData(1);
	//导出
	$("#daochu_list").unbind().on("click", function(){
         $("#daochu_c_startdate").val($("#searchForm #c_startdate").val());
         $("#daochu_c_enddate").val($("#searchForm #c_enddate").val());
         $("#daochu_cust").val($("#searchForm #cust").val());
         $("#daochu_minmoney").val($("#searchForm #minmoney").val());
         $("#daochu_maxmoney").val($("#searchForm #maxmoney").val());
         $("#daochu_recharge_type").val($("#searchForm #recharge_type").val());
         $("#daochuForm").submit();
    });	
	//查询会员
	$("#cust").blur(function(){
	   var cust = $("#cust").val();
		$("#name,#code").val("");
		$("#czmoeny,#enddate,#ydmoeny").html("");
	   if(cust!=""){
			ccms.dialog.open({url : "${def:context}/action/project/fitness/util/querycustlist/crud?pickcustname="+cust+"&objid=cust_code&objidtwo=cust&random_number="+Math.random()});
	   }else{
		   ccms.dialog.alert("请输入会员号/姓名/手机号！");
	   }
	   $("#paymoney").html("");
	   $("#moneytype").val("");
	   $("#money").val("");
	   $("#moneycash").val("0");
	   $("#moneygift").val("0");
   });
	//支付方式
	$("#moneytype").change(function(){
		document.getElementById("money").focus();
	});
	//充值
   $("#save_btn").click(function(){
		//判断当前登录人是否有收款权限
		if(parseInt("${fld:skillscopenum}")==0){
			ccms.dialog.notice("该登录人没有充值权限！", 2000);
			return false;
		}
	   if($("#moneycash").val()=="")$("#moneycash").val("0");
	   if($("#moneygift").val()=="")$("#moneygift").val("0");
	   //充值金额
	   var moneycash = $("#moneycash").val();
	   if(moneycash==0){
			ccms.dialog.alert("请输入充值金额！");
			return false;
	   }
	   if(moneycash<0){
			ccms.dialog.alert("充值金额必须大于等于0！");
			return false;
	   }
	   var moneydetail = "";
		//获取所有支付类型option
		$("#moneytype option").each(function(){  
			if($(this).val()!=""){
				moneydetail+=($("input[name=paytypemoney][code="+$(this).val()+"]").val()+";");
			}
			moneydetail = moneydetail.replace("undefined", "0");
		});
		//明细
		$("#pay_detail").val(moneydetail);
		//获取所有支付金额
		var paymoney = 0;
		$("input[name='paytypemoney']").each(function(j,item){
			paymoney+=Number(item.value);
		});
		if(Number(moneycash)!=paymoney){
			ccms.dialog.alert("实收金额与支付金额不相同，请确认！");
			return false;
		}
		//
		$Dialog().confirm("确定要充值吗？",function(){
			var uri="${def:context}${def:actionroot}/insert";
		   	ajaxCall(uri,{
		   		method: "post",
		   		form:"formEditor",
		   		progress: true,
		   		dataType: "script",
		   		success: function() {
					$Dialog().notice("充值成功！",1200,function(){
						$("#modalAddnew").modal("hide");
						search.searchData(1);
					});
		   		}
		   	});
		})
   });
	//查看
	$("#preview").click(function(){
		var obthis = getCheckboxValue("recharge");
		if(obthis!= ""){
			ccms.dialog.open({url : "${def:context}${def:actionroot}/preview?code="+obthis, width:800, height:440});
		}else{
			ccms.dialog.alert("请选择!");
		}
	});
	//退费
	$("#refund_btn").click(function(){
		//判断当前登录人是否有收款权限
		if(parseInt("${fld:skillscopenum}")==0){
			ccms.dialog.notice("该登录人没有退费权限！", 2000);
			return false;
		}

		   if($("#moneycash").val()=="")$("#moneycash").val("0");
		   //充值金额
		   var moneycash = $("#moneycash").val();
		   if(moneycash==0){
				ccms.dialog.alert("请输入退费金额！");
				return false;
		   }
		   if(moneycash<0){
				ccms.dialog.alert("退费金额必须大于等于0！");
				return false;
		   }
		   var moneydetail = "";
		   var fushu = "";
			//获取所有支付类型option
			$("#moneytype option").each(function(){  
				if($(this).val()!=""){
					moneydetail+=($("input[name=paytypemoney][code="+$(this).val()+"]").val()+";");
					fushu+=("-"+$("input[name=paytypemoney][code="+$(this).val()+"]").val()+";");
				}
				moneydetail = moneydetail.replace("undefined", "0");
				fushu = fushu.replace("undefined", "0");
			});
			//明细
			$("#pay_detail").val(moneydetail);
			$("#fushu").val(fushu);
			//获取所有退费金额
			var paymoney = 0;
			$("input[name='paytypemoney']").each(function(j,item){
				paymoney+=Number(item.value);
			});
			if(Number(moneycash)!=paymoney){
				ccms.dialog.alert("实收退费与支付退费不相同，请确认！");
				return false;
			}
			//
			$Dialog().confirm("确定要退费吗？",function(){
				var uri="${def:context}${def:actionroot}/update";
			   	ajaxCall(uri,{
			   		method: "post",
			   		form:"formEditor",
			   		progress: true,
			   		dataType: "script",
			   		success: function() {
						$Dialog().notice("退费成功！",1200,function(){
							$("#modalAddnew").modal("hide");
							search.searchData(1);
						});
			   		}
			   	});
			})
	});

	$("#money").blur(function(){
		var money = $(this).val();
		if(isNaN(money)){
			money = 0;
		}
		money = Number(money).toFixed(2);
		$(this).val(money <0 ? 0 : money);
	});
   $("#addmoney").click(function(){
	   	var moneytype = $("#moneytype").val();
	   	var moneytypetext = $("#moneytype option:selected").text();
	   	var money = $("#money").val();
	   	if(moneytype==""){
	   		ccms.dialog.alert("请选择方式！");
	   	}else if(money==""){
	   		ccms.dialog.alert("请输入金额！");
	   	}else{
	   		var count = 0;
			$("input[name='paytypemoney']").each(function(j,item){
				   if($(item).attr("code")==moneytype)count++;
			});
			if(count==0){
				$("#paymoney").append(
						"<li style='margin-left:25px;float:left'><span><span>"+moneytypetext+"：</span><span>"+money+"元</span></span>"
					+"<input type='hidden' value='"+money+"' code='"+moneytype+"'  name='paytypemoney'/>"
					+ '<img   onclick="delhour(this)" style="margin-left:5px;margin-top:-2px" height="20" width="45"   src="'+contextPath+'/js/project/fitness/image/SVG/nav/shanchu.svg" title="删除"></li>'
				);
			
				
				
				
				$("#moneytype,#money").val("");
				$("#moneytype").selectpicker("refresh");
				$("#moneytype").selectpicker("render");
			}else
				ccms.dialog.alert(moneytypetext+"已存在！");
	   	}
  });
   //打印小票
   $("#print_ticket_btn").click(function(){
	   var obthis = getCheckboxValue("recharge");
		if(obthis!= ""){
			var url = "${def:context}/action/project/fitness/print/ticket/rechargeticket?pk_value="+obthis;
			ajaxCall(url,{
				method : "get",
				progress : true,
				dataType : "script",
				success : function() {
				}
			});
		}else{
			ccms.dialog.alert("请选择!");
		}
   })
   
   selectInit($("#moneytype,#recharge_type"))
});
function delhour(val){
	$(val).parent().remove();
}
//回调查询方法
function pickcustCallback(){
	var uri="${def:context}${def:actionroot}/querycustomer?cust="+$("#cust_code").val();
   	ajaxCall(uri,{
   		method: "get",
   		progress: true,
   		dataType: "script",
   		success: function() {
   		}
   	});
}
</script>
</body>
</html>